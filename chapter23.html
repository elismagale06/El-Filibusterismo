<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Filibusterismo - Kabanata XXIII</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        h2 {
            color: #5c2e0f;
        }
        /* Small spacing and centered h2 titles for chapter pages */
        .chapter-block { margin-bottom: 30px; }
        .chapter-block h2 {
            margin: 10px 0 18px;
            text-align: center;
            font-weight: 600;
        }
        .chapter-content { padding-top: 6px; }
        /* Style for the single audio player at the end */
        .combined-audio-player {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }
        .combined-audio-player h3 {
            margin-bottom: 15px;
            color: #5c2e0f;
        }
    </style>
</head>
<body data-page="chapter">
    <div class="container">
        <header>
            <h1>Kabanata 23</h1>
            <p class="subtitle">ISANG BANGKAY</p>
        </header>

        <div class="content-section">
            <a href="chapters.html" class="back-button">← Bumalik sa Mga Kabanata</a>

            <div class="chapter-block" id="kabanata23">
                <h2>KABANATA XXIII: Isang Bangkay</h2>
                <div class="chapter-content">
                    <p>Nang gabing iyon, ikapito, ay makalawang umalis at dumating si Simoun sa bahay na may iba't ibang taong kasama. Nakita siya ni Makaraig nang mag-iikawalo sa may daang Ospital, cocido sa may dulaan nang mag-iikasiyam na may kausap na estudyante.</p>

                    <p>Si Basilio ay di rin nanood ng palabas. Nagrerepaso siya sa bahay. Hindi na sumasama sa mga kamag-aaral mula nang tubusin si Huli sa pagka-kaalila. Pinag-aralang mabuti ang pagpapagaling kay Kapitan Tiyago na noon ay lalong naging mahirap pakibagayan. Kung minsan ay mabait na mahal na mahal nito si Basilio at kung minsan ay nilalait. Pabigat nang pabigat ang karamdaman nito.</p>

                    <p>Ang pagbabawas sa paghitit ni Kapitan Tiyago ay isinasagawa ni Basilio ngunit kung nasa kaibigan o nasa paaralan ay may nagbibigay ng labis na apyan sa matanda. Si Simoun at si Padre Irene lang naman ang dumadalaw rito. Si Simoun naman ay walang itinatagubilin kay Basilio kundi ang pagalingin ang maysakit, pagtiisan ito sa pag-aalaga.</p>

                    <p>Sa pagrerepaso ni Basilio ay dumating si Simoun. Mula nang magkita sila sa San Diego ay noon lamang sila nagkaharap. Kinumusta ni Simoun ang maysakit. Malubha, ani Basilio. Malala na raw ang kalat ng lason sa katawan. Tinugtog ng isang orasan ang ikasampu. Nagitla si Simoun.</p>

                    <p>Anito kay Basilio: "Hindi ninyo binabasa ang mga aklat na ipinadala ko sa inyo. Wala kayong malasakit sa bayan..." Tinangka ni Basilio na tumugon. Nagpatuloy si Simoun: "Sa loob ng isang oras, ang paghihimagsik ay sisiklab at bukas ay wala nang pag-aaral, wala nang unibersidad at tanging patayan at paglalaban ang masasaksihan. Ang lahat ng dapat makiisa sa amin at di sumama ay ituturing naming kaaway na dapat patayin. Basilio, ano ang iyong pipiliin kamatayan o ang iyong kinabukasan? Naparito ako upang iligtas ka alang-alang sa mga alaalang bumibigkis sa atin."</p>

                    <p>Napatingin si Basilio na takang-taka sa mag-aalahas. "Nasa kamay ko na ang pamahalaan," patuloy ni Simoun. "Ang mataas na puno ay nasa dulaan. Walang makababalik sa kanila sa kanilang higaan. Ang mga kawal ko'y may iba't ibang paniwala. Ilan ay sa paniwalang ang paghihimagsik ay utos ng Heneral, ang ilan ay sa paniwalang utos ng mga prayle, ang ilan ay binayaran ko at pinangakuan ng mga tungkulin at ang napakarami ay dahil sa hangad na makapaghiganti o sila'y gipit na't kailangang mamatay o pumatay."</p>

                    <p>Sinabi rin ni Simoun na kasama niya si Kabesang Tales at ang pangkat ng pamahalaan, kung di ninyo sila papanigan.</p>

                    <p>"At ano ang aking gagawin?" tanong ng binata.</p>

                    <p>"Samantalang abala ang lungsod, mamuno kayo sa isang pangkat at lusubin ninyo ang Sta. Clara upang ilabas doon si Maria Clara"</p>

                    <p>Ibig ko siyang iligtas. Pagliligtas sa kanya ang dahilan ng pagnanais ni Simoun na makapaghimagsik, dahil isa lamang ang makapagbubukas ng pinto ng kumbento.</p>

                    <p>"Ay! Huli na kayo!" pahimutok ni Basilio. At sinabi ni Basilio na noong ikaanim ng hapon ay namatay na si Maria Clara. Naroon daw siya sa kumbento upang makibalita kaya niya nabatid. Nang bumalik siya ay nakita niya ang liham na padala ni Padre Salvi kay Padre Irene na siyang nagpabasa niyon kay Kapitan Tiyago na nagpanangis nang mabatid na patay na si Maria Clara.</p>

                    <p>Litong-lito at patakbong nanaog ng bahay si Simoun. Nawala sa pag-aaral ang isip ni Basilio. Ang naglaro sa isip ay ang kahabag-habag na buhay nina Ibarra at Maria Clara.</p>
                </div>

                <!-- Single audio player for the chapter -->
                <div class="combined-audio-player">
                    <h3>Pakinggan ang Diyalog ng Kabanata XXIII</h3>
                    <div class="audio-controls">
                        <audio controls id="chapterAudio23" preload="auto">
                            <source src="audio/Kabanata 23.MP3" type="audio/mpeg">
                            Ang iyong browser ay hindi sumusuporta sa audio player.
                        </audio>
                        <p class="audio-note"><em>Ang audio ay magpe-play awtomatiko o maaaring ipagpatuloy mula sa huling posisyon.</em></p>
                    </div>
                </div>
            </div>
            <div class="chapter-navigation-container">
                <div class="chapter-navigation">
                    <button class="nav-btn next-btn" onclick="window.location.href='talasalitaan23.html'">
                        Magpatuloy sa Talasalitaan →
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="script-chapters.js"></script>
    <script src="rain.js"></script>
    <script>
    // Auto-play script for chapter audio with state persistence
    document.addEventListener('DOMContentLoaded', function() {
        const audioElement = document.getElementById('chapterAudio23');
        if (!audioElement) return;

        // Set up audio element ID for state tracking if not present
        if (!audioElement.id) {
            audioElement.id = 'chapterAudio23';
        }

        // Load saved playback state
        loadAudioState(audioElement, '23');
        
        // Set up event listeners for state saving
        setupAudioEventListeners(audioElement, '23');
        
        // Try to auto-play with user interaction detection
        attemptAutoPlay(audioElement, '23');
        
        // Also try to play when page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioElement.paused && 
                sessionStorage.getItem('userInteractedWithAudio') === 'true') {
                attemptAutoPlay(audioElement, '23');
            }
        });
    });
    
    function loadAudioState(audioElement, chapterKey) {
        try {
            const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
            const savedIsPlaying = sessionStorage.getItem(`chapter${chapterKey}AudioIsPlaying`);
            const audioSource = sessionStorage.getItem(`chapter${chapterKey}AudioSource`);
            
            // Only restore if it's the same audio source
            const currentSource = audioElement.querySelector('source').src;
            if (savedTime && audioSource === currentSource) {
                const time = parseFloat(savedTime);
                const duration = audioElement.duration;
                
                // Only restore if position is valid and not too close to end
                if (!isNaN(time) && time > 0 && time < (duration || Infinity) - 1) {
                    audioElement.currentTime = time;
                }
                
                // Restore playback state
                if (savedIsPlaying === 'true' && audioElement.paused) {
                    sessionStorage.setItem(`shouldResumeAudio${chapterKey}`, 'true');
                }
            }
            
            // Save current source for future checks
            sessionStorage.setItem(`chapter${chapterKey}AudioSource`, currentSource);
        } catch (e) {
            console.error('Error loading audio state:', e);
        }
    }
    
    function setupAudioEventListeners(audioElement, chapterKey) {
        // Save playback position regularly
        audioElement.addEventListener('timeupdate', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
            }
        });
        
        // Save play state
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('pause', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'false');
        });
        
        audioElement.addEventListener('ended', function() {
            sessionStorage.removeItem(`chapter${chapterKey}AudioPosition`);
            sessionStorage.removeItem(`chapter${chapterKey}AudioIsPlaying`);
            sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
            // Update the note to show audio is finished
            const audioNote = document.querySelector('.audio-note');
            if (audioNote) {
                audioNote.innerHTML = '<em>Tapos na ang audio ng Kabanata XXIII.</em>';
            }
        });
        
        // Save state before page unload
        window.addEventListener('beforeunload', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
                sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            }
        });
        
        // Handle user interaction with audio element
        audioElement.addEventListener('click', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        // Handle audio errors
        audioElement.addEventListener('error', function() {
            const audioControls = audioElement.closest('.audio-controls');
            if (audioControls) {
                const errorNote = document.createElement('p');
                errorNote.className = 'audio-note'; 
                errorNote.style.color = '#cc0000';
                errorNote.innerHTML = `<em>Hindi ma-play ang audio file. Paki-check kung naka-save bilang "Kabanata 23.mp3" sa audio folder.</em>`;
                audioControls.appendChild(errorNote);
            }
        });
    }
    
    function attemptAutoPlay(audioElement, chapterKey) {
        // Check if we should resume playback
        const shouldResume = sessionStorage.getItem(`shouldResumeAudio${chapterKey}`) === 'true';
        const userInteracted = sessionStorage.getItem('userInteractedWithAudio') === 'true';
        
        if (shouldResume || userInteracted) {
            // Small delay to ensure page is ready
            setTimeout(() => {
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        
                        // Only show fallback if this is the first load
                        if (!userInteracted) {
                            showAutoplayFallback(audioElement, chapterKey);
                        }
                    }).then(() => {
                        // Clear the resume flag if successful
                        sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
                        
                        // Update the note
                        const audioNote = document.querySelector('.audio-note');
                        if (audioNote) {
                            const currentTime = Math.floor(audioElement.currentTime);
                            audioNote.innerHTML = `<em>Nagpe-play ang audio mula ${formatTime(currentTime)}. I-refresh ang pahina upang ipagpatuloy mula dito.</em>`;
                        }
                    });
                }
            }, 300);
        } else {
            // First visit, show fallback button
            showAutoplayFallback(audioElement, chapterKey);
        }
    }
    
    function showAutoplayFallback(audioElement, chapterKey) {
        const audioContainer = audioElement.closest('.audio-controls');
        if (!audioContainer) return;
        
        // Remove any existing overlay
        const existingOverlay = audioContainer.querySelector('.autoplay-fallback');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'autoplay-fallback';
        overlay.style.marginTop = '15px';
        overlay.style.padding = '15px';
        overlay.style.backgroundColor = '#f8f3e9';
        overlay.style.borderRadius = '8px';
        overlay.style.border = '1px solid #e0d5c0';
        overlay.style.textAlign = 'center';
        
        // Check if there's saved position
        const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
        let timeInfo = '';
        if (savedTime) {
            const time = Math.floor(parseFloat(savedTime));
            timeInfo = `<p style="margin-bottom: 5px; color: #5c2e0f; font-size: 0.9em;">
                <strong>Naka-save na posisyon:</strong> ${formatTime(time)}
            </p>`;
        }
        
        overlay.innerHTML = `
            <p style="margin-bottom: 10px; color: #5c2e0f; font-size: 0.95em;">
                <strong>I-play ang Kabanata XXIII</strong>
            </p>
            ${timeInfo}
            <button class="play-overlay-btn" 
                    onclick="resumeChapterAudio${chapterKey}(this)"
                    style="background: linear-gradient(to bottom, #5c2e0f, #4a240c); 
                           color: white; padding: 10px 20px; border: none; 
                           border-radius: 6px; cursor: pointer; font-weight: bold;
                           font-size: 1em; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
                           margin-top: 10px;">
                ▶ Simulan ang Audio
            </button>
            <p style="margin-top: 8px; font-size: 0.8em; color: #777;">
                Magpe-play mula sa simula o huling posisyon.
            </p>
        `;
        
        audioContainer.appendChild(overlay);
    }
    
    // Helper function to format time
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Global function for resume button (Kabanata 23)
    window.resumeChapterAudio23 = function(button) {
        const audioElement = document.getElementById('chapterAudio23');
        if (audioElement) {
            audioElement.play().then(() => {
                const overlay = button.closest('.autoplay-fallback');
                if (overlay) overlay.remove();
                sessionStorage.setItem('userInteractedWithAudio', 'true');
                
                // Update the note
                const audioNote = document.querySelector('.audio-note');
                if (audioNote) {
                    const currentTime = Math.floor(audioElement.currentTime);
                    audioNote.innerHTML = `<em>Nagpe-play ang audio ng Kabanata XXIII mula ${formatTime(currentTime)}.</em>`;
                }
            }).catch(error => {
                console.error('Playback failed:', error);
                alert('Hindi ma-play ang audio. Pakisubukan muli o i-check ang audio file.');
            });
        }
    };
</script>
</body>
</html>