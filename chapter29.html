<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Filibusterismo - Kabanata XXIX</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        h2 {
            color: #5c2e0f;
        }
        /* Small spacing and centered h2 titles for chapter pages */
        .chapter-block { margin-bottom: 30px; }
        .chapter-block h2 {
            margin: 10px 0 18px;
            text-align: center;
            font-weight: 600;
        }
        .chapter-content { padding-top: 6px; }
        /* Style for the single audio player at the end */
        .combined-audio-player {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }
        .combined-audio-player h3 {
            margin-bottom: 15px;
            color: #5c2e0f;
        }
    </style>
</head>
<body data-page="chapter">
    <div class="container">
        <header>
            <h1>Kabanata 29</h1>
            <p class="subtitle">Mga Huling Pati Ukol kay Kapitan Tiyago</p>
        </header>

        <div class="content-section">
            <a href="chapters.html" class="back-button">← Bumalik sa Mga Kabanata</a>

            <div class="chapter-block" id="kabanata29">
                <h2>KABANATA XXIX: Mga Huling Pati Ukol kay Kapitan Tiyago</h2>
                <div class="chapter-content">
                    <p>Ang libing ni Kapitan Tiyago ay napakagarbo. Si Padre Irene ang itinalagang tagapamahala at tagapagpatupad ng testamento ng kapitan. Hati-hatiin ang kanyang kayamanan sa Santa Clara, sa Papa, sa Arsobispo, at sa mga orden. May P20.00 na itinabi para sa matrikula ng mga mahihirap na estudyante. Iminungkahi ito ni Padre Irene upang ipakita ang kanyang pagiging tagapagtangkilik sa mga estudyante. Tinanggal ni Kapitan Tiyago ang P25.00 pamana para kay Basilio dahil sa sinasabing kawalang-utang-loob, ngunit binalik ito ni Padre Irene at siya na ang magpapaluwal ng pera sa sariling bulsa.</p>
                    <p>Habang nakaburol si Kapitan Tiyago, maraming usap-usapan tungkol sa kanya. Ayon sa mga mongha, nakita nila ang nagliliwanag na kaluluwa ng kapitan, na bunga ng maraming pamisang ginawa niya. Sabi ng sakristan mayor, maaaring may hawak na mangkok ng taho ang kaluluwa, dahil magiliw siya rito. May ilan din na nag-isip na baka hamunin ni Kapitan Tiyago si San Pedro sa sabong, ngunit ayon kay Pilosopo Primitivo, hindi magkakatalo ang manok dahil ang pagkatalo ay kaugnay ng sama ng loob, at ang sama ng loob ay walang puwang sa langit.</p>
                    <p>Binigyan ni Quiroga ng tabako si Don Primitivo at nagtanong nang mahinahon tungkol sa damit na isusuot kay Kapitan Tinong. Ang lumang damit na binayaran ng P36.00 ay inialay sa kaibigan. Tumutol ang sastre at sinabing prak ang kailangan, dahil nakaprak ang kaluluwang nakita ng mga mongha. May yari na siyang damit na nagkakahalaga ng P32.00 para sa namatay. Sa huli, ipinasuot kay Padre Irene ang lumang damit, ngunit sinabi na hindi mahalaga sa langit ang anumang damit.</p>
                    <p>Tatlong prayle ang dumalo sa libing ng kapitan. Maraming kandila ang sinunog at marami ring iwinisik na agua bendita.</p>
                    <p>Si Donya Patrocinio, ang matandang kaagaw ni Kapitan Tiyago sa pagpapataasan ng ihi sa pagkabanal, ay nagnais ding mamatay kinabukasan upang mailibing siya nang mas maringal at kahanga-hanga.</p>
                </div>

                <!-- Single audio player for the chapter -->
                <div class="combined-audio-player">
                    <h3>Pakinggan ang Diyalog ng Kabanata XXIX</h3>
                    <div class="audio-controls">
                        <audio controls id="chapterAudio29" preload="auto">
                            <source src="audio/Kabanata 29.mp3" type="audio/mpeg">
                            Ang iyong browser ay hindi sumusuporta sa audio player.
                        </audio>
                      <p class="audio-note"><em>Ang audio ay magpe-play awtomatiko o maaaring ipagpatuloy mula sa huling posisyon.</em></p>
                    </div>
                </div>
            </div>

            <div class="chapter-navigation-container">
                <div class="chapter-navigation">
                    <button class="nav-btn next-btn" onclick="window.location.href='talasalitaan29.html'">
                        Magpatuloy sa Talasalitaan →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script-chapters.js"></script>
    <script src="rain.js"></script>
    <script>
    // Auto-play script for chapter audio with state persistence
    document.addEventListener('DOMContentLoaded', function() {
        const audioElement = document.getElementById('chapterAudio29');
        if (!audioElement) return;

        // Set up audio element ID for state tracking if not present
        if (!audioElement.id) {
            audioElement.id = 'chapterAudio29';
        }

        // Load saved playback state
        loadAudioState(audioElement, '29');
        
        // Set up event listeners for state saving
        setupAudioEventListeners(audioElement, '29');
        
        // Try to auto-play with user interaction detection
        attemptAutoPlay(audioElement, '29');
        
        // Also try to play when page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioElement.paused && 
                sessionStorage.getItem('userInteractedWithAudio') === 'true') {
                attemptAutoPlay(audioElement, '29');
            }
        });
    });
    
    function loadAudioState(audioElement, chapterKey) {
        try {
            const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
            const savedIsPlaying = sessionStorage.getItem(`chapter${chapterKey}AudioIsPlaying`);
            const audioSource = sessionStorage.getItem(`chapter${chapterKey}AudioSource`);
            
            // Only restore if it's the same audio source
            const currentSource = audioElement.querySelector('source').src;
            if (savedTime && audioSource === currentSource) {
                const time = parseFloat(savedTime);
                const duration = audioElement.duration;
                
                // Only restore if position is valid and not too close to end
                if (!isNaN(time) && time > 0 && time < (duration || Infinity) - 1) {
                    audioElement.currentTime = time;
                }
                
                // Restore playback state
                if (savedIsPlaying === 'true' && audioElement.paused) {
                    sessionStorage.setItem(`shouldResumeAudio${chapterKey}`, 'true');
                }
            }
            
            // Save current source for future checks
            sessionStorage.setItem(`chapter${chapterKey}AudioSource`, currentSource);
        } catch (e) {
            console.error('Error loading audio state:', e);
        }
    }
    
    function setupAudioEventListeners(audioElement, chapterKey) {
        // Save playback position regularly
        audioElement.addEventListener('timeupdate', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
            }
        });
        
        // Save play state
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('pause', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'false');
        });
        
        audioElement.addEventListener('ended', function() {
            sessionStorage.removeItem(`chapter${chapterKey}AudioPosition`);
            sessionStorage.removeItem(`chapter${chapterKey}AudioIsPlaying`);
            sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
            // Update the note to show audio is finished
            const audioNote = document.querySelector('.audio-note');
            if (audioNote) {
                audioNote.innerHTML = '<em>Tapos na ang audio ng Kabanata XXIX.</em>';
            }
        });
        
        // Save state before page unload
        window.addEventListener('beforeunload', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
                sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            }
        });
        
        // Handle user interaction with audio element
        audioElement.addEventListener('click', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        // Handle audio errors
        audioElement.addEventListener('error', function() {
            const audioControls = audioElement.closest('.audio-controls');
            if (audioControls) {
                const errorNote = document.createElement('p');
                errorNote.className = 'audio-note'; 
                errorNote.style.color = '#cc0000';
                errorNote.innerHTML = `<em>Hindi ma-play ang audio file. Paki-check kung naka-save bilang "Kabanata 29.mp3" sa audio folder.</em>`;
                audioControls.appendChild(errorNote);
            }
        });
    }
    
    function attemptAutoPlay(audioElement, chapterKey) {
        // Check if we should resume playback
        const shouldResume = sessionStorage.getItem(`shouldResumeAudio${chapterKey}`) === 'true';
        const userInteracted = sessionStorage.getItem('userInteractedWithAudio') === 'true';
        
        if (shouldResume || userInteracted) {
            // Small delay to ensure page is ready
            setTimeout(() => {
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        
                        // Only show fallback if this is the first load
                        if (!userInteracted) {
                            showAutoplayFallback(audioElement, chapterKey);
                        }
                    }).then(() => {
                        // Clear the resume flag if successful
                        sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
                        
                        // Update the note
                        const audioNote = document.querySelector('.audio-note');
                        if (audioNote) {
                            const currentTime = Math.floor(audioElement.currentTime);
                            audioNote.innerHTML = `<em>Nagpe-play ang audio mula ${formatTime(currentTime)}. I-refresh ang pahina upang ipagpatuloy mula dito.</em>`;
                        }
                    });
                }
            }, 300);
        } else {
            // First visit, show fallback button
            showAutoplayFallback(audioElement, chapterKey);
        }
    }
    
    function showAutoplayFallback(audioElement, chapterKey) {
        const audioContainer = audioElement.closest('.audio-controls');
        if (!audioContainer) return;
        
        // Remove any existing overlay
        const existingOverlay = audioContainer.querySelector('.autoplay-fallback');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'autoplay-fallback';
        overlay.style.marginTop = '15px';
        overlay.style.padding = '15px';
        overlay.style.backgroundColor = '#f8f3e9';
        overlay.style.borderRadius = '8px';
        overlay.style.border = '1px solid #e0d5c0';
        overlay.style.textAlign = 'center';
        
        // Check if there's saved position
        const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
        let timeInfo = '';
        if (savedTime) {
            const time = Math.floor(parseFloat(savedTime));
            timeInfo = `<p style="margin-bottom: 5px; color: #5c2e0f; font-size: 0.9em;">
                <strong>Naka-save na posisyon:</strong> ${formatTime(time)}
            </p>`;
        }
        
        overlay.innerHTML = `
            <p style="margin-bottom: 10px; color: #5c2e0f; font-size: 0.95em;">
                <strong>I-play ang Kabanata XXIX</strong>
            </p>
            ${timeInfo}
            <button class="play-overlay-btn" 
                    onclick="resumeChapterAudio${chapterKey}(this)"
                    style="background: linear-gradient(to bottom, #5c2e0f, #4a240c); 
                           color: white; padding: 10px 20px; border: none; 
                           border-radius: 6px; cursor: pointer; font-weight: bold;
                           font-size: 1em; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
                           margin-top: 10px;">
                ▶ Simulan ang Audio
            </button>
            <p style="margin-top: 8px; font-size: 0.8em; color: #777;">
                Magpe-play mula sa simula o huling posisyon.
            </p>
        `;
        
        audioContainer.appendChild(overlay);
    }
    
    // Helper function to format time
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Global function for resume button (Kabanata 29)
    window.resumeChapterAudio29 = function(button) {
        const audioElement = document.getElementById('chapterAudio29');
        if (audioElement) {
            audioElement.play().then(() => {
                const overlay = button.closest('.autoplay-fallback');
                if (overlay) overlay.remove();
                sessionStorage.setItem('userInteractedWithAudio', 'true');
                
                // Update the note
                const audioNote = document.querySelector('.audio-note');
                if (audioNote) {
                    const currentTime = Math.floor(audioElement.currentTime);
                    audioNote.innerHTML = `<em>Nagpe-play ang audio ng Kabanata XXIX mula ${formatTime(currentTime)}.</em>`;
                }
            }).catch(error => {
                console.error('Playback failed:', error);
                alert('Hindi ma-play ang audio. Pakisubukan muli o i-check ang audio file.');
            });
        }
    };
</script>
</body>
</html>