<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Filibusterismo - Kabanata XXXVIII–XXXIX</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        h2 {
            color: #5c2e0f;
        }
        .chapter-block { margin-bottom: 30px; }
        .chapter-block h2 {
            margin: 10px 0 18px;
            text-align: center;
            font-weight: 600;
        }
        .chapter-content { padding-top: 6px; }
        /* Style for the single audio player at the end */
        .combined-audio-player {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }
        .combined-audio-player h3 {
            margin-bottom: 15px;
            color: #5c2e0f;
        }
    </style>
</head>
<body data-page="chapter-multi">
    <div class="container">
        <header>
            <h1>Kabanata 38–39</h1>
            <p class="subtitle">Pinagsamang Kabanata 38 hanggang 39</p>
        </header>

        <div class="content-section">
            <a href="chapters.html" class="back-button">← Bumalik sa Mga Kabanata</a>

            <!-- KABANATA 38 -->
            <div class="chapter-block" id="kabanata38">
                <h2>KABANATA XXXVIII: Kasaliwaang-Palad</h2>
                <div class="chapter-content">
                    <p>Sa Luzon ay may pag-uusig sa isang tulisang nagngangalang Matanglawin na pumatay sa isang hukom sa Tiyani, nanunog at nangulimbat. Ngunit ang mga nadakip lamang ay ang mga magsasakang walang sala. Ang anim o pitong magsasaka ang nadakip ng mga gwardya sibil mula sa pagsalakay ni Kabesang Tales. Sila ay nakagapos na pinaglakad sa buwan ng Mayo - walang sumbrero at panyapak. Sila ay kinukutya at kung mabubuwal ay hinahagupit.</p>
                    <p>May isang sibil na nagngangalang Carolino na hindi makatiis at pinagtanggol ang mga bihag ngunit sinabing ginagawa lamang nila iyon upang lumaban o tumakas ang mga bihag at nang sa gayon ay maaari silang barilin. Biglang may umalingangaw na putok mula sa kabundukan at tinamaan ang malupit na sibil, sumunod pang tinamaan ang Kabo. Pinaputukan ang mga bihag sa hudyat ng Kabo "Fuego!".</p>
                    <p>Sa pagitan ng putukan ay may tulisang lumitaw sa ibabaw ng isang talampas habang nagwawasiwas ng baril at ito ay sumisigaw ngunit hindi siya maintindihan. Tinutukan si Carolino ng baril ng kabo at inutusang barilin ang tulisan. Nagsitalislis ang mga nasa kabundukan at lumusob ang mga sibil. Pagdating sa taas ay nakita nila ang naghihingalong matanda at binayoneta nila ito.</p>
                </div>
                <!-- REMOVED audio player for Kabanata 38 -->
            </div>

            <!-- KABANATA 39 -->
            <div class="chapter-block" id="kabanata39">
                <h2>KABANATA XXXIX: Ang Katapusan</h2>
                <div class="chapter-content">
                    <p>Matapos mabigo ang kanyang planong pagpapasabog, matindi ang sugat sa loob at labas ni Simoun, at siya ay tumakas hanggang makarating sa bahay ni Padre Florentino. Doon, halos mawalan siya ng malay at ayaw niyang magpagamot. Ang tanging ninanais niya ay makatakas sa kamay ng mga guwardiya sibil at maipahinga ang kanyang pagod at pagkabigo.</p>
                    <p>Dahil sa matinding panghihina at desperasyon, uminom si Simoun ng lason upang hindi na siya mahuli ng mga awtoridad. Ang lason ang magiging dulo ng lahat ng kanyang paghihiganti at paghihirap.</p>
                    <p>Habang papalapit ang kamatayan, ipinagtapat ni Simoun kay Padre Florentino ang kanyang tunay na pagkakakilanlan bilang Crisóstomo Ibarra. Inilahad niya ang lahat ng sakit, galit, at pagkadismayang nagtulak sa kanya sa landas ng paghihiganti - ang pagkamatay ni Elias, ang pagwasak sa kanyang pangarap na makapiling si Maria Clara, at ang kawalan ng pag-asa sa bulok na lipunan.</p>
                    <p>Pinayuhan siya ni Padre Florentino na mali ang daang marahas na kanyang pinili; ang tunay na pagbabago ay hindi nagmumula sa dahas at paghihiganti, kundi sa malinis na layunin.</p>
                    <p>Matapos ang pagbubulalas ng damdamin, namatay si Simoun. Kinuha ni Padre Florentino ang kaha na puno ng alahas na gagamitin sana para sa rebolusyon. Upang hindi ito magamit ng masasama, itinapon niya ang kayamanan sa dagat, kasama ang panalangin na darating ang panahong ang yaman at kapangyarihan ay magiging kasangkapan ng kabutihan at kalayaan ng bayan.</p>
                </div>

                <!-- Single audio player for all chapters -->
                <div class="combined-audio-player">
                    <h3>Pakinggan ang Diyalog ng Kabanata XXXVIII–XXXIX</h3>
                    <div class="audio-controls">
                        <audio controls id="combinedChapterAudio" preload="auto">
                            <source src="audio/K38 - 39.mp3" type="audio/mpeg">
           
                            Ang iyong browser ay hindi sumusuporta sa audio player.
                        </audio>
                       <p class="audio-note"><em>Ang audio ay magpe-play awtomatiko o maaaring ipagpatuloy mula sa huling posisyon.</em></p>
                    </div>
                </div>
            </div>

            <div class="chapter-navigation-container">
                <div class="chapter-navigation">
                    <button class="nav-btn next-btn" onclick="window.location.href='talasalitaan38-39.html'">
                        Magpatuloy sa Talasalitaan →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script-chapters.js"></script>
    <script src="rain.js"></script>
    <script>
    // Auto-play script for combined chapter audio with state persistence
    document.addEventListener('DOMContentLoaded', function() {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (!audioElement) return;

        // Set up audio element ID for state tracking
        if (!audioElement.id) {
            audioElement.id = 'combinedAudio38-39';
        }

        // Load saved playback state
        loadAudioState(audioElement, '38-39');
        
        // Set up event listeners for state saving
        setupAudioEventListeners(audioElement, '38-39');
        
        // Try to auto-play with user interaction detection
        attemptAutoPlay(audioElement, '38-39');
        
        // Also try to play when page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioElement.paused && 
                sessionStorage.getItem('userInteractedWithAudio') === 'true') {
                attemptAutoPlay(audioElement, '38-39');
            }
        });
    });
    
    function loadAudioState(audioElement, chapterKey) {
        try {
            const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
            const savedIsPlaying = sessionStorage.getItem(`chapter${chapterKey}AudioIsPlaying`);
            const audioSource = sessionStorage.getItem(`chapter${chapterKey}AudioSource`);
            
            // Only restore if it's the same audio source
            const currentSource = audioElement.querySelector('source').src;
            if (savedTime && audioSource === currentSource) {
                const time = parseFloat(savedTime);
                const duration = audioElement.duration;
                
                // Only restore if position is valid and not too close to end
                if (!isNaN(time) && time > 0 && time < (duration || Infinity) - 1) {
                    audioElement.currentTime = time;
                }
                
                // Restore playback state
                if (savedIsPlaying === 'true' && audioElement.paused) {
                    sessionStorage.setItem(`shouldResumeAudio${chapterKey}`, 'true');
                }
            }
            
            // Save current source for future checks
            sessionStorage.setItem(`chapter${chapterKey}AudioSource`, currentSource);
        } catch (e) {
            console.error('Error loading audio state:', e);
        }
    }
    
    function setupAudioEventListeners(audioElement, chapterKey) {
        // Save playback position regularly
        audioElement.addEventListener('timeupdate', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
            }
        });
        
        // Save play state
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('pause', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'false');
        });
        
        audioElement.addEventListener('ended', function() {
            sessionStorage.removeItem(`chapter${chapterKey}AudioPosition`);
            sessionStorage.removeItem(`chapter${chapterKey}AudioIsPlaying`);
            sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
            // Update the note to show audio is finished
            const audioNote = document.querySelector('.audio-note');
            if (audioNote) {
                audioNote.innerHTML = '<em>Tapos na ang audio ng Kabanata XXXVIII-XXXIX.</em>';
            }
        });
        
        // Save state before page unload
        window.addEventListener('beforeunload', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
                sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            }
        });
        
        // Handle user interaction with audio element
        audioElement.addEventListener('click', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        // Handle audio errors
        audioElement.addEventListener('error', function() {
            const audioControls = audioElement.closest('.audio-controls');
            if (audioControls) {
                const errorNote = document.createElement('p');
                errorNote.className = 'audio-note'; 
                errorNote.style.color = '#cc0000';
                errorNote.innerHTML = `<em>Hindi ma-play ang audio file. Paki-check kung naka-save bilang "K38-39.mp3" sa audio folder.</em>`;
                audioControls.appendChild(errorNote);
            }
        });
    }
    
    function attemptAutoPlay(audioElement, chapterKey) {
        // Check if we should resume playback
        const shouldResume = sessionStorage.getItem(`shouldResumeAudio${chapterKey}`) === 'true';
        const userInteracted = sessionStorage.getItem('userInteractedWithAudio') === 'true';
        
        if (shouldResume || userInteracted) {
            // Small delay to ensure page is ready
            setTimeout(() => {
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        
                        // Only show fallback if this is the first load
                        if (!userInteracted) {
                            showAutoplayFallback(audioElement, chapterKey);
                        }
                    }).then(() => {
                        // Clear the resume flag if successful
                        sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
                        
                        // Update the note
                        const audioNote = document.querySelector('.audio-note');
                        if (audioNote) {
                            const currentTime = Math.floor(audioElement.currentTime);
                            audioNote.innerHTML = `<em>Nagpe-play ang audio mula ${formatTime(currentTime)}. I-refresh ang pahina upang ipagpatuloy mula dito.</em>`;
                        }
                    });
                }
            }, 300);
        } else {
            // First visit, show fallback button
            showAutoplayFallback(audioElement, chapterKey);
        }
    }
    
    function showAutoplayFallback(audioElement, chapterKey) {
        const audioContainer = audioElement.closest('.audio-controls');
        if (!audioContainer) return;
        
        // Remove any existing overlay
        const existingOverlay = audioContainer.querySelector('.autoplay-fallback');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'autoplay-fallback';
        overlay.style.marginTop = '15px';
        overlay.style.padding = '15px';
        overlay.style.backgroundColor = '#f8f3e9';
        overlay.style.borderRadius = '8px';
        overlay.style.border = '1px solid #e0d5c0';
        overlay.style.textAlign = 'center';
        
        // Check if there's saved position
        const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
        let timeInfo = '';
        if (savedTime) {
            const time = Math.floor(parseFloat(savedTime));
            timeInfo = `<p style="margin-bottom: 5px; color: #5c2e0f; font-size: 0.9em;">
                <strong>Naka-save na posisyon:</strong> ${formatTime(time)}
            </p>`;
        }
        
        overlay.innerHTML = `
            <p style="margin-bottom: 10px; color: #5c2e0f; font-size: 0.95em;">
                <strong>I-play ang Kabanata XXXVIII-XXXIX</strong>
            </p>
            ${timeInfo}
            <button class="play-overlay-btn" 
                    onclick="resumeChapterAudio3839(this)"
                    style="background: linear-gradient(to bottom, #5c2e0f, #4a240c); 
                           color: white; padding: 10px 20px; border: none; 
                           border-radius: 6px; cursor: pointer; font-weight: bold;
                           font-size: 1em; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
                           margin-top: 10px;">
                ▶ Simulan ang Audio
            </button>
            <p style="margin-top: 8px; font-size: 0.8em; color: #777;">
                Magpe-play mula sa simula o huling posisyon.
            </p>
        `;
        
        audioContainer.appendChild(overlay);
    }
    
    // Helper function to format time
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Global function for resume button (Kabanata 38-39)
    window.resumeChapterAudio3839 = function(button) {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (audioElement) {
            audioElement.play().then(() => {
                const overlay = button.closest('.autoplay-fallback');
                if (overlay) overlay.remove();
                sessionStorage.setItem('userInteractedWithAudio', 'true');
                
                // Update the note
                const audioNote = document.querySelector('.audio-note');
                if (audioNote) {
                    const currentTime = Math.floor(audioElement.currentTime);
                    audioNote.innerHTML = `<em>Nagpe-play ang audio ng Kabanata XXXVIII-XXXIX mula ${formatTime(currentTime)}.</em>`;
                }
            }).catch(error => {
                console.error('Playback failed:', error);
                alert('Hindi ma-play ang audio. Pakisubukan muli o i-check ang audio file.');
            });
        }
    };
</script>
</body>
</html>