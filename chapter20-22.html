<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Filibusterismo - Kabanata XX–XXII</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        h2 {
            color: #5c2e0f;
        }
        /* Small spacing and centered h2 titles for chapter pages */
        .chapter-block { margin-bottom: 30px; }
        .chapter-block h2 {
            margin: 10px 0 18px;
            text-align: center;
            font-weight: 600;
        }
        .chapter-content { padding-top: 6px; }
        /* Style for the single audio player at the end */
        .combined-audio-player {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }
        .combined-audio-player h3 {
            margin-bottom: 15px;
            color: #5c2e0f;
        }
    </style>
</head>
<body data-page="chapter-multi">
    <div class="container">
        <header>
            <h1>Kabanata 20–22</h1>
            <p class="subtitle">Pinagsamang Kabanata 20 hanggang 22</p>
        </header>

        <div class="content-section">
            <a href="chapters.html" class="back-button">← Bumalik sa Mga Kabanata</a>

            <div class="chapter-block" id="kabanata20">
                <h2>KABANATA XX: Ang Tagapagmungkahi</h2>
                <div class="chapter-content">
                    <p>Pagkalipas ng dalawang oras mula sa perya sa Quiapo, hinarap muli ni Don Custodio ang suliranin sa paaralan. Si Don Custodio ay isang batambatang Kastila na mestiso, may talino at lakas ng loob, at naging maimpluwensiyang tao sa lipunan. Nangalakal siya, tumanggap ng mga kontrata sa pamahalaan, naging konsehal at kagawad sa iba't ibang samahan, at naging tagapayo sa mga opisyal at institusyon ng pamahalaan. Bagama't nakaranas siya ng pang-aalipusta sa Espanya, bumalik siya sa Pilipinas na pinagkakakitaan at pinupuri ng mga tao.</p>
                    <p>Para kay Don Custodio, ang Pilipinas ay dapat yumabong para sa kapakinabangan ng mga Kastila. Mababa ang kanyang pagtingin sa mga Pilipino, at naniniwala siyang ipinanganak silang maging utusan at dapat supilin. Ipinagmamalaki niya ang relihiyong kinakatawan ng mga prayle at gumagamit ng disiplina, gaya ng yantok, upang pasunurin ang mga Pilipino. Hindi siya naniniwala sa himala o sa pagkakamali ng mga Papa, at mas naniniwala sa kontrol at paghahari ng Kastila kaysa sa karapatan ng mga katutubo.</p>
                    <p>Nang tanungin siya ng mataas na kawani tungkol sa balak na paaralan nina Isagani, ngumiti lamang siya at iniisip ang posibleng solusyon. Sa kalaunan, nagdesisyon siyang gumawa ng hakbang na sa tingin niya ay makabubuti sa kaniyang layunin at sa pagpapatakbo ng paaralan.</p>
                </div>
                <!-- REMOVED audio player for Kabanata 20 -->
            </div>

            <div class="chapter-block" id="kabanata21">
                <h2>KABANATA XXI: Mga Anyo ng Taga-Maynila</h2>
                <div class="chapter-content">
                    <p>Sa gabing iyon ay may pagtatanghal ng opera na Les Cloches de Corneville sa Teatro de Pranses. Ubos agad ang tiket at mahabang linya ang naghihintay. Isang Kastila, si Camarroncocido, ang nagpakita na parang pulubi at hindi interesado sa pagpasok, habang may lumapit sa kanya na isang kayumangging lalaking matanda na tinulungan siyang makahanap ng hanapbuhay sa pagdidikit ng mga paskil.</p>
                    <p>Ipinakita sa kabanata ang pagkakaiba ng mga tao sa Maynila: may mga tumututol sa palabas dahil masama ito sa moralidad, gaya nina Don Custodio at mga prayle, habang may mga natutuwa at pumupuri. Lumabat na maraming kasabwat ang simbahan sa pagbawal, at ang pagbabalangkas ng paskil ay mabisang paraan upang makahikayat ng tao sa isang palabas.</p>
                    <p>Sa gitna ng gulo, ipinakita rin si Tadeo, na niloloko ang isang kababayan sa pamamagitan ng mga kasinungalingang tungkol sa mga taong kilala sa Maynila. Dumating rin sina Paulita Gomez at Donya Victorina, pati na ang nakabalatkayong si Padre Irene at si Don Custodio. Nakilala rin ng iba sina Makaraig, Pecson, Sandoval, at Isagani, ngunit hindi sumama si Basilio.</p>
                    <p>Sa kabanatang ito, ipinapakita ang masalimuot na lipunan ng Maynila: may agwat sa uri, interes, at moralidad; may mga taong mapagpanggap at may mga inosente o naiipit sa kalakaran. Ipinapakita rin ang kontrastong karakter nina Camarroncocido at Don Custodio: ang isa'y simpleng Kastila na nagpakumbaba sa Maynila, ang isa'y makasarili at mapagsamantala sa kapangyarihan.</p>
                </div>
                <!-- REMOVED audio player for Kabanata 21 -->
            </div>

            <div class="chapter-block" id="kabanata22">
                <h2>KABANATA XXII: ANG PALABAS</h2>
                <div class="chapter-content">
                    <p>Maingay sa teatro sa oras ng pagtatanghal. Mahaba ang pila ng mga tao at maraming sagupaan sa loob, lalo na sa mga upuan ng mataas na opisyal. Dumating ang Kapitan Heneral at tumugtog ang Marcha Real. Nasa palko si Pepay, at pinilit niyang mapasama si Don Custodio sa dulaan. Masaya ang mga estudyante, lalo na si Pecson, ngunit si Isagani ay naiirita dahil nakita niya si Paulita kasama si Pelaez, ang kanyang karibal.</p>
                    <p>Ang palabas ay may mang-aawit na Pransesa, si Gertrude, at nagkaroon ng kaguluhan sa pagsasalin ng mga salita si Tadeo at Juanito Pelaez, na nagpapanggap na marunong sa Pranses ngunit mali ang pagsasalin. May mga awayan sa mga upuan, pagtutuwid, at pagtawa sa mga palabas, kasama ang mga eksena ng pagkakahiwalay ng mga magkapalko.</p>
                    <p>Napag-usapan din ang hindi pagsipot ni Simoun. Pinagtalunan ng mga estudyante ang kagandahan at kahinaan ng wikang Pranses, habang dumating si Makaraig mula kay Pepay at nagdala ng balita tungkol sa paaralan. Napagkasunduan na ipaiilalim ang paaralan sa Unibersidad ng Sto. Tomas sa pamamahala ng mga Dominiko.</p>
                    <p>Sa huli, nagpasya ang mga estudyante na ipagdiwang ang tagumpay sa isang pansiteriya at umalis na sa teatro bago magsimula ang ikalawang yugto ng operela.</p>
                </div>

                <!-- Single audio player for all chapters -->
                <div class="combined-audio-player">
                    <h3>Pakinggan ang Diyalog ng Kabanata 20-22</h3>
                    <div class="audio-controls">
                        <audio controls id="combinedChapterAudio" preload="auto">
                            <source src="audio/K20 - 22.mp3" type="audio/mpeg">
    
                            Ang iyong browser ay hindi sumusuporta sa audio player.
                        </audio>
                       <p class="audio-note"><em>Ang audio ay magpe-play awtomatiko o maaaring ipagpatuloy mula sa huling posisyon.</em></p>
                    </div>
                </div>
            </div>

            <div class="chapter-navigation-container">
                <div class="chapter-navigation">
                    <button class="nav-btn next-btn" onclick="window.location.href='talasalitaan20-22.html'">
                        Magpatuloy sa Talasalitaan →
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="script-chapters.js"></script>
    <script src="rain.js"></script>
    <script>
    // Auto-play script for combined chapter audio with state persistence
    document.addEventListener('DOMContentLoaded', function() {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (!audioElement) return;

        // Set up audio element ID for state tracking
        if (!audioElement.id) {
            audioElement.id = 'combinedAudio20-22';
        }

        // Load saved playback state
        loadAudioState(audioElement, '20-22');
        
        // Set up event listeners for state saving
        setupAudioEventListeners(audioElement, '20-22');
        
        // Try to auto-play with user interaction detection
        attemptAutoPlay(audioElement, '20-22');
        
        // Also try to play when page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioElement.paused && 
                sessionStorage.getItem('userInteractedWithAudio') === 'true') {
                attemptAutoPlay(audioElement, '20-22');
            }
        });
    });
    
    function loadAudioState(audioElement, chapterKey) {
        try {
            const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
            const savedIsPlaying = sessionStorage.getItem(`chapter${chapterKey}AudioIsPlaying`);
            const audioSource = sessionStorage.getItem(`chapter${chapterKey}AudioSource`);
            
            // Only restore if it's the same audio source
            const currentSource = audioElement.querySelector('source').src;
            if (savedTime && audioSource === currentSource) {
                const time = parseFloat(savedTime);
                const duration = audioElement.duration;
                
                // Only restore if position is valid and not too close to end
                if (!isNaN(time) && time > 0 && time < (duration || Infinity) - 1) {
                    audioElement.currentTime = time;
                }
                
                // Restore playback state
                if (savedIsPlaying === 'true' && audioElement.paused) {
                    sessionStorage.setItem(`shouldResumeAudio${chapterKey}`, 'true');
                }
            }
            
            // Save current source for future checks
            sessionStorage.setItem(`chapter${chapterKey}AudioSource`, currentSource);
        } catch (e) {
            console.error('Error loading audio state:', e);
        }
    }
    
    function setupAudioEventListeners(audioElement, chapterKey) {
        // Save playback position regularly
        audioElement.addEventListener('timeupdate', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
            }
        });
        
        // Save play state
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('pause', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'false');
        });
        
        audioElement.addEventListener('ended', function() {
            sessionStorage.removeItem(`chapter${chapterKey}AudioPosition`);
            sessionStorage.removeItem(`chapter${chapterKey}AudioIsPlaying`);
            sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
            // Update the note to show audio is finished
            const audioNote = document.querySelector('.audio-note');
            if (audioNote) {
                audioNote.innerHTML = '<em>Tapos na ang audio ng Kabanata XX-XXII.</em>';
            }
        });
        
        // Save state before page unload
        window.addEventListener('beforeunload', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
                sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            }
        });
        
        // Handle user interaction with audio element
        audioElement.addEventListener('click', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        // Handle audio errors
        audioElement.addEventListener('error', function() {
            const audioControls = audioElement.closest('.audio-controls');
            if (audioControls) {
                const errorNote = document.createElement('p');
                errorNote.className = 'audio-note'; 
                errorNote.style.color = '#cc0000';
                errorNote.innerHTML = `<em>Hindi ma-play ang audio file. Paki-check kung naka-save bilang "K20-22.mp3" sa audio folder.</em>`;
                audioControls.appendChild(errorNote);
            }
        });
    }
    
    function attemptAutoPlay(audioElement, chapterKey) {
        // Check if we should resume playback
        const shouldResume = sessionStorage.getItem(`shouldResumeAudio${chapterKey}`) === 'true';
        const userInteracted = sessionStorage.getItem('userInteractedWithAudio') === 'true';
        
        if (shouldResume || userInteracted) {
            // Small delay to ensure page is ready
            setTimeout(() => {
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        
                        // Only show fallback if this is the first load
                        if (!userInteracted) {
                            showAutoplayFallback(audioElement, chapterKey);
                        }
                    }).then(() => {
                        // Clear the resume flag if successful
                        sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
                        
                        // Update the note
                        const audioNote = document.querySelector('.audio-note');
                        if (audioNote) {
                            const currentTime = Math.floor(audioElement.currentTime);
                            audioNote.innerHTML = `<em>Nagpe-play ang audio mula ${formatTime(currentTime)}. I-refresh ang pahina upang ipagpatuloy mula dito.</em>`;
                        }
                    });
                }
            }, 300);
        } else {
            // First visit, show fallback button
            showAutoplayFallback(audioElement, chapterKey);
        }
    }
    
    function showAutoplayFallback(audioElement, chapterKey) {
        const audioContainer = audioElement.closest('.audio-controls');
        if (!audioContainer) return;
        
        // Remove any existing overlay
        const existingOverlay = audioContainer.querySelector('.autoplay-fallback');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'autoplay-fallback';
        overlay.style.marginTop = '15px';
        overlay.style.padding = '15px';
        overlay.style.backgroundColor = '#f8f3e9';
        overlay.style.borderRadius = '8px';
        overlay.style.border = '1px solid #e0d5c0';
        overlay.style.textAlign = 'center';
        
        // Check if there's saved position
        const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
        let timeInfo = '';
        if (savedTime) {
            const time = Math.floor(parseFloat(savedTime));
            timeInfo = `<p style="margin-bottom: 5px; color: #5c2e0f; font-size: 0.9em;">
                <strong>Naka-save na posisyon:</strong> ${formatTime(time)}
            </p>`;
        }
        
        overlay.innerHTML = `
            <p style="margin-bottom: 10px; color: #5c2e0f; font-size: 0.95em;">
                <strong>I-play ang Kabanata XX-XXII</strong>
            </p>
            ${timeInfo}
            <button class="play-overlay-btn" 
                    onclick="resumeChapterAudio2022(this)"
                    style="background: linear-gradient(to bottom, #5c2e0f, #4a240c); 
                           color: white; padding: 10px 20px; border: none; 
                           border-radius: 6px; cursor: pointer; font-weight: bold;
                           font-size: 1em; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
                           margin-top: 10px;">
                ▶ Simulan ang Audio
            </button>
            <p style="margin-top: 8px; font-size: 0.8em; color: #777;">
                Magpe-play mula sa simula o huling posisyon.
            </p>
        `;
        
        audioContainer.appendChild(overlay);
    }
    
    // Helper function to format time
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Global function for resume button (Kabanata 20-22)
    window.resumeChapterAudio2022 = function(button) {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (audioElement) {
            audioElement.play().then(() => {
                const overlay = button.closest('.autoplay-fallback');
                if (overlay) overlay.remove();
                sessionStorage.setItem('userInteractedWithAudio', 'true');
                
                // Update the note
                const audioNote = document.querySelector('.audio-note');
                if (audioNote) {
                    const currentTime = Math.floor(audioElement.currentTime);
                    audioNote.innerHTML = `<em>Nagpe-play ang audio ng Kabanata XX-XXII mula ${formatTime(currentTime)}.</em>`;
                }
            }).catch(error => {
                console.error('Playback failed:', error);
                alert('Hindi ma-play ang audio. Pakisubukan muli o i-check ang audio file.');
            });
        }
    };
</script>
</body>
</html>