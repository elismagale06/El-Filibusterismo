<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Filibusterismo - Kabanata XXXVI–XXXVII</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        h2 {
            color: #5c2e0f;
        }
        .chapter-block { margin-bottom: 30px; }
        .chapter-block h2 {
            margin: 10px 0 18px;
            text-align: center;
            font-weight: 600;
        }
        .chapter-content { padding-top: 6px; }
        /* Style for the single audio player at the end */
        .combined-audio-player {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }
        .combined-audio-player h3 {
            margin-bottom: 15px;
            color: #5c2e0f;
        }
    </style>
</head>
<body data-page="chapter-multi">
    <div class="container">
        <header>
            <h1>Kabanata 36–37</h1>
            <p class="subtitle">Pinagsamang Kabanata 36 hanggang 37</p>
        </header>

        <div class="content-section">
            <a href="chapters.html" class="back-button">← Bumalik sa Mga Kabanata</a>

            <!-- KABANATA 36 -->
            <div class="chapter-block" id="kabanata36">
                <h2>KABANATA XXXVI - Mga Kagipitan ni Ben Zayb</h2>
                <div class="chapter-content">
                    <p>Nagmamadaling tumakbo mula sa bahay ni Kapitan Tiyago si Ben Zayb upang sulatin ang mga nangyari. Pinalabas niyang bayani ang Kapitan Heneral, sina Padre Irene, Don Custodio at Padre Salvi. Nang ipasa ito ay hindi tinanggap dahil pinagbawal ng heneral ang pagbanggit sa mga nangyari.</p>
                    <p>Dumating ang balita mula sa Pasig na nilusob ng mga tulisan ang bahay-pahingahan ng mga prayle na nagresulta sa pagkatangay ng 2,000 piso at malubha ang isang prayle at dalawang utusan. Ginawang bayani ni Ben Zayb ang kura at 10,000 ang nakuhang pera.</p>
                    <p>Nagtungo siya sa Pasig. Natagpuan niyang sugatan si Padre Camorra. Doon pinagpatika sa kasalanang ginawa niya kay Tiyani. Tatlo sa tulisang ang may gulok at 50 piso ang nakuha ngunit sinabi ni Ben Zayb na paramihin ang tulisan.</p>
                    <p>May mga tulisang nahuli. Sila raw ay inanyayahang sumama sa pangkat ni Matanglawin upang sumalakay sa bahay ng mayayaman at kumbento. Pangungunan sila ng isang Kastila, kayumanggi, maputi ang buhok na kumikilos sa utos ng kapitan Heneral. Ang hudyat ay isang malakas na putok ngunit ng walang putok ay nagsipulasan ang mga kasapi. Ang tatlong tulisan ay naisipang manloob.</p>
                    <p>Ayaw paniwalaan ang deskripsyon kay Simoun. Ngunit hindi siya makita at ang bahay niya ay nakitaan ng maraming pulbura. Naghain ng habla si Don Custodio laban kay Simoun. Mabilis na kumalat ang balitang tungkol sa mag-aalahas.</p>
                </div>
                <!-- REMOVED audio player for Kabanata 36 -->
            </div>

            <!-- KABANATA 37 -->
            <div class="chapter-block" id="kabanata37">
                <h2>KABANATA XXXVII: Ang Kahiwagaan</h2>
                <div class="chapter-content">
                    <p>Sa kabila ng pagkukubli ay nalaman ng madla ang paghihimagsik. Si Chikoy, isang platero na nagdala ng hikaw kay Paulita ay nakita ang mga supot-supot ng pulbura habang tinatanggal ang palamuti sa kasalan nila Paulita at Juanito. Pinaghinalaan ang mga prayle, si Quiroga, isang estudyante at si Makaraig kasama sina Don Timoteo at si Simoun bilang may pakana. Ngunit ayon sa ilang kawani ay si Simoun ang may salarin.</p>
                    <p>Naalala ni Momoy, isang dumalo sa piging ang pag-alis ni Simoun sa bahay bago magsimula ang hapunan. Pag-anin pa ni Chikoy ay nawawala si Simoun at siyang dagdag pa ang alala ni Momoy na ang gaserang itinapon na umaandap ay kay Simoun.</p>
                    <p>Nahintakutan si Momoy ngunit nagtapang-tapangan para sa kasintahan at nagsabi na masama kumuha ng hindi naman inaari. Matapos lapitan ni Momoy si Isagani dahil nabatid na nakatingin ang binata ay Sinang ayunan ito ni Isagani at matapos ay umalis.</p>
                </div>

                <!-- Single audio player for all chapters -->
                <div class="combined-audio-player">
                    <h3>Pakinggan ang Diyalog ng Kabanata XXXVI-XXXVII</h3>
                    <div class="audio-controls">
                        <audio controls id="combinedChapterAudio" preload="auto">
                            <source src="audio/Kabanata 36 - 37.MP3" type="audio/mpeg">

                            Ang iyong browser ay hindi sumusuporta sa audio player.
                        </audio>
                     <p class="audio-note"><em>Ang audio ay magpe-play awtomatiko o maaaring ipagpatuloy mula sa huling posisyon.</em></p>
                    </div>
                </div>
            </div>

            <div class="chapter-navigation-container">
                <div class="chapter-navigation">
                    <button class="nav-btn next-btn" onclick="window.location.href='talasalitaan36-37.html'">
                        Magpatuloy sa Talasalitaan →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script-chapters.js"></script>
    <script src="rain.js"></script>
    <script>
    // Auto-play script for combined chapter audio with state persistence
    document.addEventListener('DOMContentLoaded', function() {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (!audioElement) return;

        // Set up audio element ID for state tracking
        if (!audioElement.id) {
            audioElement.id = 'combinedAudio36-37';
        }

        // Load saved playback state
        loadAudioState(audioElement, '36-37');
        
        // Set up event listeners for state saving
        setupAudioEventListeners(audioElement, '36-37');
        
        // Try to auto-play with user interaction detection
        attemptAutoPlay(audioElement, '36-37');
        
        // Also try to play when page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioElement.paused && 
                sessionStorage.getItem('userInteractedWithAudio') === 'true') {
                attemptAutoPlay(audioElement, '36-37');
            }
        });
    });
    
    function loadAudioState(audioElement, chapterKey) {
        try {
            const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
            const savedIsPlaying = sessionStorage.getItem(`chapter${chapterKey}AudioIsPlaying`);
            const audioSource = sessionStorage.getItem(`chapter${chapterKey}AudioSource`);
            
            // Only restore if it's the same audio source
            const currentSource = audioElement.querySelector('source').src;
            if (savedTime && audioSource === currentSource) {
                const time = parseFloat(savedTime);
                const duration = audioElement.duration;
                
                // Only restore if position is valid and not too close to end
                if (!isNaN(time) && time > 0 && time < (duration || Infinity) - 1) {
                    audioElement.currentTime = time;
                }
                
                // Restore playback state
                if (savedIsPlaying === 'true' && audioElement.paused) {
                    sessionStorage.setItem(`shouldResumeAudio${chapterKey}`, 'true');
                }
            }
            
            // Save current source for future checks
            sessionStorage.setItem(`chapter${chapterKey}AudioSource`, currentSource);
        } catch (e) {
            console.error('Error loading audio state:', e);
        }
    }
    
    function setupAudioEventListeners(audioElement, chapterKey) {
        // Save playback position regularly
        audioElement.addEventListener('timeupdate', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
            }
        });
        
        // Save play state
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('pause', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'false');
        });
        
        audioElement.addEventListener('ended', function() {
            sessionStorage.removeItem(`chapter${chapterKey}AudioPosition`);
            sessionStorage.removeItem(`chapter${chapterKey}AudioIsPlaying`);
            sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
            // Update the note to show audio is finished
            const audioNote = document.querySelector('.audio-note');
            if (audioNote) {
                audioNote.innerHTML = '<em>Tapos na ang audio ng Kabanata XXXVI-XXXVII.</em>';
            }
        });
        
        // Save state before page unload
        window.addEventListener('beforeunload', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
                sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            }
        });
        
        // Handle user interaction with audio element
        audioElement.addEventListener('click', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        // Handle audio errors
        audioElement.addEventListener('error', function() {
            const audioControls = audioElement.closest('.audio-controls');
            if (audioControls) {
                const errorNote = document.createElement('p');
                errorNote.className = 'audio-note'; 
                errorNote.style.color = '#cc0000';
                errorNote.innerHTML = `<em>Hindi ma-play ang audio file. Paki-check kung naka-save bilang "Kabanata 36-37.mp3" sa audio folder.</em>`;
                audioControls.appendChild(errorNote);
            }
        });
    }
    
    function attemptAutoPlay(audioElement, chapterKey) {
        // Check if we should resume playback
        const shouldResume = sessionStorage.getItem(`shouldResumeAudio${chapterKey}`) === 'true';
        const userInteracted = sessionStorage.getItem('userInteractedWithAudio') === 'true';
        
        if (shouldResume || userInteracted) {
            // Small delay to ensure page is ready
            setTimeout(() => {
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        
                        // Only show fallback if this is the first load
                        if (!userInteracted) {
                            showAutoplayFallback(audioElement, chapterKey);
                        }
                    }).then(() => {
                        // Clear the resume flag if successful
                        sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
                        
                        // Update the note
                        const audioNote = document.querySelector('.audio-note');
                        if (audioNote) {
                            const currentTime = Math.floor(audioElement.currentTime);
                            audioNote.innerHTML = `<em>Nagpe-play ang audio mula ${formatTime(currentTime)}. I-refresh ang pahina upang ipagpatuloy mula dito.</em>`;
                        }
                    });
                }
            }, 300);
        } else {
            // First visit, show fallback button
            showAutoplayFallback(audioElement, chapterKey);
        }
    }
    
    function showAutoplayFallback(audioElement, chapterKey) {
        const audioContainer = audioElement.closest('.audio-controls');
        if (!audioContainer) return;
        
        // Remove any existing overlay
        const existingOverlay = audioContainer.querySelector('.autoplay-fallback');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'autoplay-fallback';
        overlay.style.marginTop = '15px';
        overlay.style.padding = '15px';
        overlay.style.backgroundColor = '#f8f3e9';
        overlay.style.borderRadius = '8px';
        overlay.style.border = '1px solid #e0d5c0';
        overlay.style.textAlign = 'center';
        
        // Check if there's saved position
        const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
        let timeInfo = '';
        if (savedTime) {
            const time = Math.floor(parseFloat(savedTime));
            timeInfo = `<p style="margin-bottom: 5px; color: #5c2e0f; font-size: 0.9em;">
                <strong>Naka-save na posisyon:</strong> ${formatTime(time)}
            </p>`;
        }
        
        overlay.innerHTML = `
            <p style="margin-bottom: 10px; color: #5c2e0f; font-size: 0.95em;">
                <strong>I-play ang Kabanata XXXVI-XXXVII</strong>
            </p>
            ${timeInfo}
            <button class="play-overlay-btn" 
                    onclick="resumeChapterAudio3637(this)"
                    style="background: linear-gradient(to bottom, #5c2e0f, #4a240c); 
                           color: white; padding: 10px 20px; border: none; 
                           border-radius: 6px; cursor: pointer; font-weight: bold;
                           font-size: 1em; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
                           margin-top: 10px;">
                ▶ Simulan ang Audio
            </button>
            <p style="margin-top: 8px; font-size: 0.8em; color: #777;">
                Magpe-play mula sa simula o huling posisyon.
            </p>
        `;
        
        audioContainer.appendChild(overlay);
    }
    
    // Helper function to format time
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Global function for resume button (Kabanata 36-37)
    window.resumeChapterAudio3637 = function(button) {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (audioElement) {
            audioElement.play().then(() => {
                const overlay = button.closest('.autoplay-fallback');
                if (overlay) overlay.remove();
                sessionStorage.setItem('userInteractedWithAudio', 'true');
                
                // Update the note
                const audioNote = document.querySelector('.audio-note');
                if (audioNote) {
                    const currentTime = Math.floor(audioElement.currentTime);
                    audioNote.innerHTML = `<em>Nagpe-play ang audio ng Kabanata XXXVI-XXXVII mula ${formatTime(currentTime)}.</em>`;
                }
            }).catch(error => {
                console.error('Playback failed:', error);
                alert('Hindi ma-play ang audio. Pakisubukan muli o i-check ang audio file.');
            });
        }
    };
</script>
</body>
</html>