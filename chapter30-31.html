<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>El Filibusterismo - Kabanata XXX–XXXI</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
        h2 {
            color: #5c2e0f;
        }
        /* Small spacing and centered h2 titles for chapter pages */
        .chapter-block { margin-bottom: 30px; }
        .chapter-block h2 {
            margin: 10px 0 18px;
            text-align: center;
            font-weight: 600;
        }
        .chapter-content { padding-top: 6px; }
        /* Style for the single audio player at the end */
        .combined-audio-player {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }
        .combined-audio-player h3 {
            margin-bottom: 15px;
            color: #5c2e0f;
        }
    </style>
</head>
<body data-page="chapter">
    <div class="container">
        <header>
            <h1>Kabanata 30 at 31</h1>
            <p class="subtitle">Pinagsamang Kabanata 30 hanggang 31</p>
        </header>

        <div class="content-section">
            <a href="chapters.html" class="back-button">← Bumalik sa Mga Kabanata</a>

            <!-- KABANATA 30 -->
            <div class="chapter-block" id="kabanata30">
                <h2>KABANATA XXX: Si Huli</h2>
                <div class="chapter-content">
                    <p>Kumalat sa San Diego ang balita tungkol sa pagkamatay ni Kapitan Tiyago at pagkakakulong ni Basilio. Mas ikinalungkot ng mga tao ang sinapit ni Basilio dahil sinasabing maaari siyang ipatapon o bitayin. Ikinukumpara pa siya sa tatlong paring martir ng Cavite na binitay noong Enero, kaya maraming naniniwalang tiyak na ganoon din ang mangyayari sa kanya.</p>
                    <p>Ayon kay Hermana Penchang, ang dinanas ni Basilio ay parusa raw dahil hindi ito gumagamit ng agwa bendita sa simbahan, na aniya'y hindi naman marumi at nakapagpapagaling pa. May ilang naniwala sa ganitong paniniwala, ngunit mas marami ang nagsasabing paghihiganti lamang ito ng mga prayle dahil sa kaugnayan ni Basilio kay Huli, na anak ni Kabesang Tales.</p>
                    <p>Ipinagmamalaki ni Hermana Penchang na pinaalis niya si Huli sa kanilang bahay upang hindi siya madamay sa galit ng mga prayle. Sa katunayan, ayaw naman talaga niyang tulungan si Huli upang ipatubos ito.</p>
                    <p>Si Hermana Bali ang nagbalita kay Huli tungkol sa sinapit ni Basilio. Sa tindi ng hinagpis at takot, nahimatay si Huli. Dahil patay na si Kapitan Tiyago, wala nang makapangyarihang magtatanggol kay Basilio, kaya inaakalang mabubulok ito sa bilangguan o mamamatay kahit walang kasalanan.</p>
                    <p>Nagpasya si Huli na gumawa ng paraan upang matulungan si Basilio. May bumuo sa kanyang isip na lumapit kay Padre Camorra, na may kapangyarihang magpalaya ng mga bilanggo. Ngunit may masamang karanasan na si Huli sa kura dahil humingi ito noon ng kapalit na "pagpapakasakit," kaya't iniwasan na niya ito. Kilala rin si Padre Camorra sa masamang pagtingin sa mga dalaga, kaya't naging paksa ng tsismis si Huli sa bayan.</p>
                    <p>Dahil sa mga pangyayaring ito, lalong naging malungkot si Huli. Minsan ay naitanong pa niya kung ang pagpapakamatay ay kasalanang humahantong sa impiyerno. Hindi niya itinuloy ang balak dahil sa takot sa parusa ng Diyos.</p>
                    <p>Iminungkahi ni Hermana Bali na humingi sila ng payo sa isang tagasulat sa tribunal, ngunit wala itong naitulong at itinuro lamang sila sa hukom pamayapa. Ayon sa hukom, tanging si Padre Camorra lamang ang maaaring makapagalaya kay Basilio kung nanaisin nito sabay tingin kay Huli.</p>
                    <p>Tahimik lamang si Huli. Batid ni Hermana Bali ang panganib ng paglapit kay Padre Camorra, ngunit iginiit niyang tungkulin ng mga dalaga ang lumapit sa kumbento kapag may suliranin. Nakiusap si Huli na si Hermana Bali na lamang ang pumunta, subalit sinabi ng hukom na mas mabisa ang pakiusap ng isang batang dalaga kaysa sa isang matanda.</p>
                    <p>Habang naglalakad, muling nag-alinlangan si Huli. Ang hinihinging kapalit ng kura ay labag sa kanyang dangal at magiging kasalanan din sa alaala ng kanyang ama. Ngunit para kay Basilio, handa ba siyang isakripisyo ang sarili? Natakot siyang hamakin din siya ni Basilio kung mangyari iyon.</p>
                    <p>Gabi-gabing binabagabag si Huli ng masasamang panaginip: dugo, putok ng baril, ang naghihingalong si Basilio, at ang anyo ng kanyang ama. Kinabukasan, kumalat ang balitang may mga estudyanteng binaril. Nagpasya si Huli na kinabukasan ay pupunta na siya sa kumbento, anuman ang mangyari. Ngunit muli siyang umurong, at lumipas ang mga araw na puno ng takot at pag-aalala.</p>
                    <p>Sa wakas, nabalitaan niyang lahat ng estudyante ay pinalaya na maliban kay Basilio, na ipatatapon daw sa Carolinas. Dahil dito, nagbihis si Huli ng kanyang pinakamagandang damit at hinanap si Hermana Bali upang tuluyang magpunta sa kumbento.</p>
                    <p>Malapit na sila sa bayan nang muling manghina ang loob ni Huli. Ngunit pinilit siya ni Hermana Bali, sinasabing kung pababayaan niya si Basilio, pagsisisihan niya ito habambuhay. Kaya't napilitan siyang sumama.</p>
                    <p>Kinahapunan ding iyon, kumalat ang balita na tumalon si Huli mula sa bintana ng kumbento at namatay matapos bumagsak sa mga bato sa ibaba. Si Hermana Bali ay nagtatakbo at humihingi ng tulong, samantalang si Tandang Selo ay itinaboy at sinaktan nang subukang pumasok sa kumbento.</p>
                    <p>May isang babaeng nagdasal para sa katarungan ng Diyos, ngunit sinabi ng kanyang asawa na kung tunay ang Diyos, ang mga gumagawa ng ganitong kasamaan ang unang hindi naniniwala sa kanya.</p>
                    <p>Nang gabing iyon, maraming pari ang nagtipon sa kumbento. Kinabukasan, biglang nawala si Tandang Selo, dala ang kanyang mga gamit sa pangangaso.</p>
                </div>
                <!-- REMOVED audio player for Kabanata 30 -->
            </div>

            <!-- KABANATA 31 -->
            <div class="chapter-block" id="kabanata31">
                <h2>KABANATA XXXI: Ang Mataas na Kawani</h2>
                <div class="chapter-content">
                    <p>Hindi naibalita sa mga pahayagan ang sinapit ni Huli. Tahimik ding inalis si Padre Camorra sa Tiyani. Samantala, isa-isang pinalaya ang mga estudyanteng nakulong: una si Makaraig at huli si Isagani. Dahil sa mga isinulat ni Ben Zayb, lumaganap ang balitang mahabagin ang Kapitan Heneral. Gayunman, si Basilio lamang ang nanatiling nakakulong.</p>
                    <p>Isang mataas na kawani ng pamahalaan ang nagtangkang ipagtanggol si Basilio. Ayon sa kanya, mabuting mag-aaral ang binata at malapit nang matapos sa pag-aaral ng medisina. Ngunit sa halip na makatulong, lalo pang napahamak si Basilio dahil sinasalungat ng Kapitan Heneral ang bawat mungkahi ng kawani. Para sa Heneral, kailangang magbigay ng halimbawa upang takutin ang mga taong may hangaring magbago ng sistema.</p>
                    <p>Mariing iginiit ng kawani na si Basilio ang pinaka-inosente sa lahat ng estudyante. Ngunit iginiit naman ng kalihim na may mga aklat na ipinagbabawal. Ipinaliwanag ng kawani na ang mga aklat ni Basilio ay pawang ginagamit sa unibersidad at ang iba ay hindi pa nga nababasa. Wala rin umanong kinalaman si Basilio sa mga pagtitipon ng mga mag-aaral.</p>
                    <p>Tahasan namang sinabi ng Kapitan Heneral na layon niyang maghasik ng takot upang sumunod ang lahat, may sala man o wala. Nang tanungin ng kawani kung hindi ba siya natatakot sa magiging bunga nito, malamig na sinagot ng Heneral na wala siyang dapat ikatakot sapagkat wala umanong kapangyarihan ang bayan laban sa kanya.</p>
                    <p>Muling nagsalita ang mataas na kawani at pinaalala sa Heneral na bagama't hindi siya inihalal ng mga Pilipino kundi ng Espanya, nanumpa pa rin siyang mamahala nang may katarungan. Ipinaliwanag ng kawani na bagama't siya ay Kastila, higit sa lahat ay isa siyang tao na naniniwala sa dangal, katarungan, at karangalan. Hindi raw kailangang maging malupit ang Espanya upang manatiling dakila.</p>
                    <p>Binalaan ng kawani ang Heneral na kung patuloy na ipagkakait sa bayan ang liwanag, katarungan, at kalayaan, darating ang panahong maghihimagsik ang mga Pilipino. At kung mangyari iyon, sinabi niyang papanig siya sa mga inaaping mamamayan.</p>
                    <p>Hindi na tumugon ang Kapitan Heneral at sa halip ay nagtanong lamang kung kailan aalis ang susunod na koreo. Umalis ang mataas na kawani at habang nasa sasakyan ay sinabi sa kanyang kutserong Pilipino na sana'y maalala ng bayan na may mga Kastilang tumindig para sa kanila.</p>
                    <p>Pagkaraan ng dalawang oras, nagbitiw sa tungkulin ang mataas na kawani at nagpasyang bumalik sa Espanya sakay ng susunod na bapor.</p>
                </div>

                <!-- Single audio player for both chapters -->
                <div class="combined-audio-player">
                    <h3>Pakinggan ang Diyalog ng Kabanata XXX-XXXI</h3>
                    <div class="audio-controls">
                        <audio controls id="combinedChapterAudio" preload="auto">
                            <source src="audio/Kabanata 30 - 31.mp3" type="audio/mpeg">
                            Ang iyong browser ay hindi sumusuporta sa audio player.
                        </audio>
                     <p class="audio-note"><em>Ang audio ay magpe-play awtomatiko o maaaring ipagpatuloy mula sa huling posisyon.</em></p>
                </div>
            </div>

            <div class="chapter-navigation-container">
                <div class="chapter-navigation">
                    <button class="nav-btn next-btn" onclick="window.location.href='talasalitaan30-31.html'">
                        Magpatuloy sa Talasalitaan →
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="script-chapters.js"></script>
    <script src="rain.js"></script>
    <script>
    // Auto-play script for combined chapter audio with state persistence
    document.addEventListener('DOMContentLoaded', function() {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (!audioElement) return;

        // Set up audio element ID for state tracking
        if (!audioElement.id) {
            audioElement.id = 'combinedAudio30-31';
        }

        // Load saved playback state
        loadAudioState(audioElement, '30-31');
        
        // Set up event listeners for state saving
        setupAudioEventListeners(audioElement, '30-31');
        
        // Try to auto-play with user interaction detection
        attemptAutoPlay(audioElement, '30-31');
        
        // Also try to play when page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && audioElement.paused && 
                sessionStorage.getItem('userInteractedWithAudio') === 'true') {
                attemptAutoPlay(audioElement, '30-31');
            }
        });
    });
    
    function loadAudioState(audioElement, chapterKey) {
        try {
            const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
            const savedIsPlaying = sessionStorage.getItem(`chapter${chapterKey}AudioIsPlaying`);
            const audioSource = sessionStorage.getItem(`chapter${chapterKey}AudioSource`);
            
            // Only restore if it's the same audio source
            const currentSource = audioElement.querySelector('source').src;
            if (savedTime && audioSource === currentSource) {
                const time = parseFloat(savedTime);
                const duration = audioElement.duration;
                
                // Only restore if position is valid and not too close to end
                if (!isNaN(time) && time > 0 && time < (duration || Infinity) - 1) {
                    audioElement.currentTime = time;
                }
                
                // Restore playback state
                if (savedIsPlaying === 'true' && audioElement.paused) {
                    sessionStorage.setItem(`shouldResumeAudio${chapterKey}`, 'true');
                }
            }
            
            // Save current source for future checks
            sessionStorage.setItem(`chapter${chapterKey}AudioSource`, currentSource);
        } catch (e) {
            console.error('Error loading audio state:', e);
        }
    }
    
    function setupAudioEventListeners(audioElement, chapterKey) {
        // Save playback position regularly
        audioElement.addEventListener('timeupdate', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
            }
        });
        
        // Save play state
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('pause', function() {
            sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'false');
        });
        
        audioElement.addEventListener('ended', function() {
            sessionStorage.removeItem(`chapter${chapterKey}AudioPosition`);
            sessionStorage.removeItem(`chapter${chapterKey}AudioIsPlaying`);
            sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
            // Update the note to show audio is finished
            const audioNote = document.querySelector('.audio-note');
            if (audioNote) {
                audioNote.innerHTML = '<em>Tapos na ang audio ng Kabanata XXX-XXXI.</em>';
            }
        });
        
        // Save state before page unload
        window.addEventListener('beforeunload', function() {
            if (!audioElement.paused && audioElement.currentTime > 0) {
                sessionStorage.setItem(`chapter${chapterKey}AudioPosition`, audioElement.currentTime);
                sessionStorage.setItem(`chapter${chapterKey}AudioIsPlaying`, 'true');
            }
        });
        
        // Handle user interaction with audio element
        audioElement.addEventListener('click', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        audioElement.addEventListener('play', function() {
            sessionStorage.setItem('userInteractedWithAudio', 'true');
        });
        
        // Handle audio errors
        audioElement.addEventListener('error', function() {
            const audioControls = audioElement.closest('.audio-controls');
            if (audioControls) {
                const errorNote = document.createElement('p');
                errorNote.className = 'audio-note'; 
                errorNote.style.color = '#cc0000';
                errorNote.innerHTML = `<em>Hindi ma-play ang audio file. Paki-check kung naka-save bilang "Kabanata 30-31.mp3" sa audio folder.</em>`;
                audioControls.appendChild(errorNote);
            }
        });
    }
    
    function attemptAutoPlay(audioElement, chapterKey) {
        // Check if we should resume playback
        const shouldResume = sessionStorage.getItem(`shouldResumeAudio${chapterKey}`) === 'true';
        const userInteracted = sessionStorage.getItem('userInteractedWithAudio') === 'true';
        
        if (shouldResume || userInteracted) {
            // Small delay to ensure page is ready
            setTimeout(() => {
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        
                        // Only show fallback if this is the first load
                        if (!userInteracted) {
                            showAutoplayFallback(audioElement, chapterKey);
                        }
                    }).then(() => {
                        // Clear the resume flag if successful
                        sessionStorage.removeItem(`shouldResumeAudio${chapterKey}`);
                        
                        // Update the note
                        const audioNote = document.querySelector('.audio-note');
                        if (audioNote) {
                            const currentTime = Math.floor(audioElement.currentTime);
                            audioNote.innerHTML = `<em>Nagpe-play ang audio mula ${formatTime(currentTime)}. I-refresh ang pahina upang ipagpatuloy mula dito.</em>`;
                        }
                    });
                }
            }, 300);
        } else {
            // First visit, show fallback button
            showAutoplayFallback(audioElement, chapterKey);
        }
    }
    
    function showAutoplayFallback(audioElement, chapterKey) {
        const audioContainer = audioElement.closest('.audio-controls');
        if (!audioContainer) return;
        
        // Remove any existing overlay
        const existingOverlay = audioContainer.querySelector('.autoplay-fallback');
        if (existingOverlay) existingOverlay.remove();
        
        const overlay = document.createElement('div');
        overlay.className = 'autoplay-fallback';
        overlay.style.marginTop = '15px';
        overlay.style.padding = '15px';
        overlay.style.backgroundColor = '#f8f3e9';
        overlay.style.borderRadius = '8px';
        overlay.style.border = '1px solid #e0d5c0';
        overlay.style.textAlign = 'center';
        
        // Check if there's saved position
        const savedTime = sessionStorage.getItem(`chapter${chapterKey}AudioPosition`);
        let timeInfo = '';
        if (savedTime) {
            const time = Math.floor(parseFloat(savedTime));
            timeInfo = `<p style="margin-bottom: 5px; color: #5c2e0f; font-size: 0.9em;">
                <strong>Naka-save na posisyon:</strong> ${formatTime(time)}
            </p>`;
        }
        
        overlay.innerHTML = `
            <p style="margin-bottom: 10px; color: #5c2e0f; font-size: 0.95em;">
                <strong>I-play ang Kabanata XXX-XXXI</strong>
            </p>
            ${timeInfo}
            <button class="play-overlay-btn" 
                    onclick="resumeChapterAudio3031(this)"
                    style="background: linear-gradient(to bottom, #5c2e0f, #4a240c); 
                           color: white; padding: 10px 20px; border: none; 
                           border-radius: 6px; cursor: pointer; font-weight: bold;
                           font-size: 1em; box-shadow: 0 3px 5px rgba(0,0,0,0.2);
                           margin-top: 10px;">
                ▶ Simulan ang Audio
            </button>
            <p style="margin-top: 8px; font-size: 0.8em; color: #777;">
                Magpe-play mula sa simula o huling posisyon.
            </p>
        `;
        
        audioContainer.appendChild(overlay);
    }
    
    // Helper function to format time
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Global function for resume button (Kabanata 30-31)
    window.resumeChapterAudio3031 = function(button) {
        const audioElement = document.getElementById('combinedChapterAudio');
        if (audioElement) {
            audioElement.play().then(() => {
                const overlay = button.closest('.autoplay-fallback');
                if (overlay) overlay.remove();
                sessionStorage.setItem('userInteractedWithAudio', 'true');
                
                // Update the note
                const audioNote = document.querySelector('.audio-note');
                if (audioNote) {
                    const currentTime = Math.floor(audioElement.currentTime);
                    audioNote.innerHTML = `<em>Nagpe-play ang audio ng Kabanata XXX-XXXI mula ${formatTime(currentTime)}.</em>`;
                }
            }).catch(error => {
                console.error('Playback failed:', error);
                alert('Hindi ma-play ang audio. Pakisubukan muli o i-check ang audio file.');
            });
        }
    };
</script>
</body>
</html>